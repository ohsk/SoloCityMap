 <!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" name="viewport">
    <title>Solo map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <!-- jquery and jquery UI -->
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
    <!-- Chosen -->
    <script type="text/javascript" src="src/script/chosen.jquery.min.js"></script>    
    <link rel="stylesheet" href="src/css/chosen.min.css">
    <!-- FONTS -->
    <link href='http://fonts.googleapis.com/css?family=Raleway:300,400,500' rel='stylesheet' type='text/css'>  
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> 
    <!-- Mapbox -->
    <script type="text/javascript" src='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.css' rel='stylesheet' type='text/css'/>    
    <!-- Taffy DB -->
    <script type="text/javascript" src="src/script/taffy-min.js"></script>
    <!-- STYLE -->
    <link rel="stylesheet" href="src/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="src/css/style.css">
    <!-- [pure stylesheets] -->
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/grids-responsive-min.css">
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/menus-min.css">
    <link rel="stylesheet" href="src/css/structure.css">
    <!--<![endif]-->   
  </head>
  <body>
    <div id="layout" class="content pure-g">
      <div id="nav" class="pure-u">
        <a href="#" class="nav-menu-button">Menu</a>
        <h6 style="margin-top:0; padding-top:0.5em">Solo City Map</h6>
        <div class="nav-inner">
          <div class="pure-menu pure-menu-open">
            <ul>
              <li><a href="#">Lorem</a></li>
              <li><a href="#">Ipsum</a></li>
              <li><a href="#">Dolor</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div id="list-header" class="pure-u">
        <select id="kelurahan_selector" style="width: 320px;" data-placeholder="Select a kelurahan"></select>
        <div id="filter_conditions" style= "display: none">
          <select id="subcategory_filter" data-placeholder="Select Subcategories..." style="width: 320px; display:none">
          </select>
          <div id="was_voted_filter">            
            <input type="checkbox" id="was_voted_filter_ALL" value="ALL"></input>
            <label for="was_voted_filter_ALL">All</label>
            <input type="checkbox" id="was_voted_filter_VO" value="VO"></input>
            <label for="was_voted_filter_VO">Voted</label>
            <input type="checkbox" id="was_voted_filter_NV" value="NV"></input>
            <label for="was_voted_filter_NV">Ghost project</label>
          </div>
          <div id="is_it_executed_filter">
            <input type="checkbox" id="is_it_executed_filter_ALL" value="ALL"></input>
            <label for="is_it_executed_filter_ALL">All</label>
            <input type="checkbox" id="is_it_executed_filter_YES" value="YES"></input>
            <label for="is_it_executed_filter_YES">Executed</label>
            <input type="checkbox" id="is_it_executed_filter_NO" value="NO"></input>
            <label for="is_it_executed_filter_NO">Not executed</label>
          </div>
          <p>Planned budget:<span id="total_budget">0.00</span> IDR
          </p>
          <div id="budget_bar">
            <div class="bar_element JA" id="bar_element_JA"></div>
            <div class="bar_element SA" id="bar_element_SA"></div>
            <div class="bar_element SM" id="bar_element_SM"></div>
            <div class="bar_element LS" id="bar_element_LS"></div>
            <div class="bar_element AR" id="bar_element_AR"></div>
            <div class="bar_element IC" id="bar_element_IC"></div>
            <div class="bar_element DR" id="bar_element_DR"></div>
            <div class="bar_element SR" id="bar_element_SR"></div>              
          </div>          
        </div>
      </div>
      <div id="main">
        <div id="map-canvas"></div>
          <h4 id="kelurahan_name"></h4>
          <div id="tools_container">
            <button type="button" id="layers_button"></button>
            <div id="year_selector">
                <p>Tahun penyaring</p>
            </div>
            <div id="layer_tools" style="display:none">
              <select id="aggregate_data_selector">
                <option value="" disabled="disabled" selected="selected">Select a data layer</option>
                <option value="POVERTY_PERCENTAGE">Poverty percentage</option>
                <option value="NO_SCHOOL_PERCENTAGE">Percentage of children not in school</option>
              </select>
            </div>
          </div>
        </div>  
        <div id="list" class="pure-u"> 
      </div>  
    </div>
     <script type="text/javascript">
      //***********************************************************************
      //***********************Here goes the stuff for the map*****************
      //***********************************************************************
      var kelurahansFusionTableID = "1jdxsdPlAvCNRair4uv2pOwWTzMNtutDdhfXlp9QO";
      var subdivisionsFusionTableID = "158fKZygrAlgGKaYDkT4alniT5ZEeTqPdwtFtEoc-";
      var musrenbangFusionTableID = "1yHXZ3Z5yQXl8eEewPUgYSzOvd458RhW9pQ2smFIf";
      var data2010FusionTableID = "1oMln7GsJjbGJ9CQK41FP-aq3Xkz7fJPVZof2U5rY";
      var projectFields = [
        {KEY:"KELURAHAN", NAME:"Kelurahan", TYPE:"TEXT"},
        {KEY:"YEAR", NAME:"Year", TYPE:"NUMBER"},
        {KEY:"VOTED", NAME:"Voted", TYPE:"TEXT"},
        {KEY:"CATEGORY", NAME:"Category", TYPE:"TEXT"},
        {KEY:"SUBCATEGORY", NAME:"Subcategory", TYPE:"TEXT"},
        {KEY:"UNIQUE_NUMBER", NAME:"Unique number", TYPE:"NUMBER"},
        {KEY:"LEVEL", NAME:"Level", TYPE:"TEXT"},
        {KEY:"PRIORITY", NAME:"Priority", TYPE:"NUMBER"},
        {KEY:"PROJECT_NAME", NAME:"Project name", TYPE:"TEXT"},
        {KEY:"LOCATION", NAME:"Location", TYPE:"TEXT"},
        {KEY:"AGENCY", NAME:"Agency", TYPE:"TEXT"},
        {KEY:"PLANNED_BUDGET", NAME:"Planned budget", TYPE:"NUMBER"},
        {KEY:"EXECUTED_BUDGET", NAME:"Executed budget", TYPE:"NUMBER"},
        {KEY:"IS_IT_EXECUTED", NAME:"Is it executed", TYPE:"TEXT"},
        {KEY:"NOTES", NAME:"Notes", TYPE:"TEXT"}
      ];

      var dataFields = [
        {KEY:"KELURAHAN", NAME:"Kelurahan", TYPE:"text"},
        {KEY:"TOTAL_HH", NAME:"Total Households", TYPE:"number"},
        {KEY:"TOTAL_CITIZENS", NAME:"Total Citizens", TYPE:"number"},
        {KEY:"AVERAGE_HH_SIZE", NAME:"Average household size", TYPE:"number"},
        {KEY:"TOTAL_7_18", NAME:"Total children between 7 and 18", TYPE:"number"},
        {KEY:"NO_SCHOOL", NAME:"Total children not in school", TYPE:"number"},
        {KEY:"NO_SCHOOL_PERCENTAGE", NAME:"Percentage of children not in school", TYPE:"number"},
        {KEY:"TOTAL_HH_WC", NAME:"Total households with private WC", TYPE:"number"},
        {KEY:"PRIVATE_WC_PERCENTAGE", NAME:"Percentage of households with private WC", TYPE:"number"},
        {KEY:"TOTAL_HH_WC_PUBLIC", NAME:"Total households with private WC", TYPE:"number"},
        {KEY:"WC_PUBLIC_PERCENTAGE", NAME:"Percentage of households with private WC", TYPE:"number"},
        {KEY:"TOTAL_PDAM", NAME:"Total PDAM", TYPE:"number"},
        {KEY:"PDAM_PERCENTAGE", NAME:"Percentage of PDAM", TYPE:"number"},
        {KEY:"TOTAL_HH_PUBLIC_WELLS", NAME:"Total households with public wells", TYPE:"number"},
        {KEY:"PUBLIC_WELLS_PERCENTAGE", NAME:"Public wells percentage", TYPE:"number"},
        {KEY:"TOTAL_HH_PRIVATE_WELLS", NAME:"Total household with private wells", TYPE:"number"},
        {KEY:"PRIVATE_WELLS_PERCENTAGE", NAME:"Percentage of private wells", TYPE:"number"},
        {KEY:"TOTAL_HOUSES", NAME:"Total houses", TYPE:"number"},
        {KEY:"TOTAL_LAND_TENURE", NAME:"Total land tenure", TYPE:"number"},
        {KEY:"LAND_TENURE_PERCENTAGE", NAME:"Land tenure percentage", TYPE:"number"},
        {KEY:"HOUSES_HH_RATIO", NAME:"Houses household ratio", TYPE:"number"},
        {KEY:"TOTAL_POOR_HH", NAME:"Total poor households", TYPE:"number"},
        {KEY:"POVERTY_PERCENTAGE", NAME:"Poverty percentage", TYPE:"number"}
      ];   
      var projectDatabase =  TAFFY();
      var aggregateDataDatabase = TAFFY();
      //var colors = ['#BEC1C4', '#AB8A71', '#F0BC6E', '#F7DE8C']; // More neutral, similar to Kota Kita site
      var colors = ['#BEC1C4']; // More neutral, similar to Kota Kita site
      var percentageColor = "#8A0707";
      var originalKelurahanShapeOptions = {
        color: "#000000",
        opacity: 1,
        weight: 1,
        fillColor: "#FFFFFF",
        fillOpacity: 0,
      };
      var onHoverKelurahanShapeOptions = {
        color: "#000000",
        opacity: 1,
        weight: 2,
        fillColor: "#FFFFFF",
        fillOpacity: 0,
      };
      var activeKelurahanShapeOptions = {
        color: "#FFFF00",
        opacity: 1,
        weight: 4,
        fillColor: "#FFFFFF",
        fillOpacity: 0,        
      };      
      var originalLocationShapeOptions = {
        color: "#000000",
        opacity: 1,
        weight: 1,
        fillColor: "#BEC1C4",
        fillOpacity: 0.5,
      };
      var originalKelurahanOpacity = 0.7;
      var onHoverKelurahanOpacity = 0.3;
      var activeKelurahanOpacity = 0.1;
      var map;
      var kelurahans = [];
      var subdivisions = {};
      var projectsArray = [];
      var subcategoryIcons;
      var mapSC;
      var kelurahanLayer;
      var projectLocationLayer;
      document.addEventListener("DOMContentLoaded", initialize);
      var subcategories = {
        JA : {name: "Jalan",
          color: "#4C4320"},
        SA : {name: "Sanitasi",
          color: "#573649"},        
        SM : {name: "Mannakemen sampah",
          color: "#601D00"},        
        LS : {name: "Listrik",
          color: "#E7922A"},        
        AR : {name: "Air Bersih", 
          color: "#003951"},        
        IC : {name: "Informasi dan komunicasi",
          color: "#B65B46"},        
        DR : {name: "Drainase",
          color: "#7FA6B2"},        
        SR : {name: "Saran lainnyn",
          color: "#C0B58F"}        
      };   
      function initialize() {
        subcategoryIcons = new getSubcategoryIcons();
        getSubdivisions();
        getProjects();
        getKelurahans();
        get2010Data();
        mapSC = new mapStateController();
        initializeLayerToolbar();
      }
      function initializeLayerToolbar(){
        var layerButton = document.getElementById("layers_button");
        layers_button.onclick = function(){
          toggleLayerToolbar();
        }
        var aggregateDataLayerSelector = document.getElementById("aggregate_data_selector");
        aggregateDataLayerSelector.onchange = function(){
          var aggregateDataLayerSelector = document.getElementById("aggregate_data_selector");
          var selectedLayer = aggregateDataLayerSelector.options[aggregateDataLayerSelector.selectedIndex].value;
          showDataLayer(selectedLayer);
        }
      }
      function toggleLayerToolbar(){
        var layerTools = document.getElementById("layer_tools");
        var displayStyle = window.getComputedStyle(layerTools, null).getPropertyValue("display");
        if(displayStyle === "none"){
          layerTools.style.display = "block";
        } else {
          layerTools.style.display = "none";
        }
      }
      function getKelurahans(){
        var query = 'SELECT KELURAHAN, geometry, geometry_pos FROM ' + kelurahansFusionTableID;
        getFusionTablesData(query, "parseKelurahans");
      }
      function getSubdivisions(){
        var query = 'SELECT KELURAHAN, geometry, geometry_pos, RW, RT FROM ' + subdivisionsFusionTableID;
        getFusionTablesData(query, "parseSubdivisions");
      }
      function get2010Data(){
        var columnNames = getWhatToGet(dataFields);
        var query = 'SELECT ' + columnNames + '  FROM ' + data2010FusionTableID;
        getFusionTablesData(query, "parseData");
      }
      function mapStateController(){
        L.mapbox.accessToken = 'pk.eyJ1Ijoic3RlcGhlbmtlbm5lZHkiLCJhIjoidjE2aTktdyJ9.gpYsw_JQAEuHlK5rAq0rsw';
        map = L.mapbox.map("map-canvas", 'stephenkennedy.ad4e43ac')
        .setView([-7.566667, 110.816667], 13);
        kelurahanLayer =  L.mapbox.featureLayer().addTo(map);
        projectLocationLayer = L.mapbox.featureLayer().addTo(map);
        var state;
        var possibleStates = {
            Default: 0,
            Main: 1,
            Kelurahan: 2,
        };
        state = possibleStates.Default;
        var yearCheckboxes = [];
        var selectedKelurahan = null;
        var selectedProjectID = null;
        var scFilters = new subcategoryFilters(this);
        this.filters = document.getElementById("filter_conditions");
        this.GPFilter = new ghostProjectFilters(this);
        this.EPFilter = new executedProjectFilters(this);
        this.BBar = new budgetBar();
        this.kelSelect = null;
        this.showMain = function(){
        }
        this.selectKelurahan = function(kelurahanToSelect){
            document.getElementById("kelurahan_name").innerHTML = kelurahanToSelect.name;
            state = possibleStates.Kelurahan;
            map.fitBounds(kelurahanToSelect.kelurahanShape.getBounds());
            kelurahanToSelect.kelurahanShape.bringToFront();
            if(selectedKelurahan != null){
              selectedKelurahan.setDeselected();
            }
            selectedKelurahan = kelurahanToSelect;
            //selectedKelurahanIndex = kelurahanIndex;
            kelurahanToSelect.setSelected();
            this.addFiltersUI();
            $("#was_voted_filter").buttonset();
            $("#is_it_executed_filter").buttonset();
            emptyProjectCards();
            this.filteringChanged();
            this.kelSelect.selectKelurahan(kelurahanToSelect.name);
        }
        this.selectKelurahanByName = function(kelurahanName){
          for (var i = kelurahans.length - 1; i >= 0; i--) {
            if (kelurahans[i].name == kelurahanName){
              this.selectKelurahan(kelurahans[i]);
              break;
            }
          };
        }
        this.onKelurahanMouseOver = function(kelurahan){
          if(kelurahan != selectedKelurahan){
            document.getElementById("kelurahan_name").innerHTML = kelurahan.name;
          }
        }
        this.onKelurahanClick = function(kelurahan){
          this.selectKelurahan(kelurahan);
        }
        this.onKelurahanMouseOut = function(kelurahan){
          if(selectedKelurahan != null){
            document.getElementById("kelurahan_name").innerHTML = selectedKelurahan.name;
          } else {
            document.getElementById("kelurahan_name").innerHTML = "";
          }
        }
        this.onProjectsParsed = function(){
          this.initializeYearSelector();
        }
        this.initializeYearSelector = function(){
          var minYear = projectDatabase().min("YEAR");
          var maxYear = projectDatabase().max("YEAR");
          var yearSelector = document.getElementById("year_selector");
          yearCheckboxes = [];
          for (var i = minYear; i <= maxYear; i++){
            var input = document.createElement("input");
            input.type = "checkbox";
            input.id = "year_" + i;
            input.year = i;
            var label = document.createElement("label");
            label.htmlFor = "year_" + i;
            label.textContent = i;
            var that = this;
            input.onchange = function(){
              that.filteringChanged();
            }
            yearSelector.appendChild(input);
            yearSelector.appendChild(label);
            yearCheckboxes.push(input);
          }
          document.getElementById("year_" + maxYear).checked = true; // Selecting the last year by default.
          $("#year_selector").buttonset();
        }
        this.filteringChanged = function(){
          switch(state){
            case possibleStates.Default :
              break;
            case possibleStates.Main :
              break;
            case possibleStates.Kelurahan :
              var years = [];
              this.emptyProjectLocationLayer();
              for (var i = 0; i < yearCheckboxes.length; i++){
                if(yearCheckboxes[i].checked){
                  years.push(yearCheckboxes[i].year);
                }
              }
              var scSelected = scFilters.getSelected();
              var gpFilterSelected = this.GPFilter.getActiveFilter();
              var exFilterSelected = this.EPFilter.getActiveFilter();
              emptyProjectCards();
              var cardData = fillProjectCards(selectedKelurahan.name, years, scSelected, gpFilterSelected, exFilterSelected, this);
              this.BBar.updateBar(cardData);
              break;
          }
        }
        this.setSelectedProject = function(projectID){
          if(selectedProjectID != null){
            this.emptyProjectLocationLayer();
          }
          selectedProjectID = projectID;
          //window.alert(selectedProjectID);
          var project = projectDatabase({ID: selectedProjectID}).get()[0];
          var location = project.LOCATION.split(',');
          var kelurahan = project.KELURAHAN;
          var subcategory = subcategories[project.SUBCATEGORY];
          this.showLocationShapes(kelurahan, subcategory, location);
        }
        this.emptyProjectLocationLayer = function(){
          map.removeLayer(projectLocationLayer);
          projectLocationLayer = L.mapbox.featureLayer().addTo(map);
          selectedProjectID = null;
        }
        this.showLocationShapes = function(kelurahan, subcategory, locations){  
          var shapeOptions = originalLocationShapeOptions;
          shapeOptions.fillColor = subcategory.color;
          for (var i=0; i<locations.length; i++){
            if(locations[i].indexOf("-") !=-1){
              var tempLoc = locations[i].split("-");
              var geometry = subdivisions[kelurahan][tempLoc[0].substring(2, tempLoc[0].length)][tempLoc[1].substring(2, tempLoc[1].length)].GEOMETRIES;
              var shape = L.polygon(geometry, shapeOptions);
              shape.addTo(projectLocationLayer);
            } else if(locations[i].indexOf("RW") !=-1){
              var locationsToShow = subdivisions[kelurahan][locations[i].substring(2,locations[i].length)];
              for(var key in locationsToShow){
                var geometry = locationsToShow[key].GEOMETRIES;
                var shape = L.polygon(geometry, shapeOptions);
                shape.addTo(projectLocationLayer);
              }
            } else if(locations[i] == "KELURAHAN"){
              var kelurahanLocations = subdivisions[kelurahan];
              for(var key in kelurahanLocations){
                var rwLocations = kelurahanLocations[key];
                for(var key in rwLocations){
                  var rtLocations = rwLocations[key];
                  if(rtLocations.hasOwnProperty("GEOMETRIES")){
                    var geometry = rtLocations.GEOMETRIES;
                    var shape = L.polygon(geometry, shapeOptions);
                    shape.addTo(projectLocationLayer);       
                  }
                }
              }
            }
          }
        }
        this.addKelurahanSelector = function(){
          this.kelSelect = new kelurahanSelector(this);
          this.kelSelect.initialize();
        }
        this.addFiltersUI = function(){
          switch(state){
            case possibleStates.Default :
              break;
            case possibleStates.Main :
              break;
            case possibleStates.Kelurahan :
                this.filters.style.display = "inherit";
                scFilters.show();
              break;
          }
        }
      }
      function kelurahanSelector(parent){
        this.parent = parent;
        this.kelSelector = document.getElementById("kelurahan_selector");
        this.kelSelector.multiple = false;
        this.kelOptions = [];
        var that = this;
        this.kelSelector.onchange = function(){
          that.parent.selectKelurahanByName(this.options[this.selectedIndex].value);
        }
        this.initialize = function(){
            //Adding blank text option
            var option = document.createElement("option");
            option.innerHTML = "";
            option.value = "";
            this.kelSelector.appendChild(option);
            this.kelOptions.push(option);
            for (var i = 0; i < kelurahans.length; i++) {
              var option = document.createElement("option");
              option.innerHTML = kelurahans[i].name;
              option.id = "kel_" + kelurahans[i].name;
              option.value = kelurahans[i].name;
              this.kelSelector.appendChild(option);
              this.kelOptions.push(option);
            };
            $(this.kelSelector).attr('data-placeholder', "Select a kelurahan").chosen({allow_single_deselect: true});
        }
        this.selectKelurahan = function(kelurahanName){
          if(this.kelSelector.options[this.kelSelector.selectedIndex].value != kelurahanName){
            for (var i = this.kelOptions.length - 1; i >= 0; i--) {
              if (this.kelOptions[i].value == kelurahanName){
                this.kelSelector.selectedIndex = i;
                $(this.kelSelector).trigger("chosen:updated"); 
                break;
              }
            };
          }
        }        
      }
      function ghostProjectFilters(parent){
        this.parent = parent;
        var that = this;
        this.callback = function(){
          if(!this.checked){
            that.all.checked = false;
            $(that.all).button("refresh")
          }
          if ((that.nv.checked) && (that.vo.checked)){
            that.all.checked = true;
            $(that.all).button("refresh")
          }
          that.parent.filteringChanged();
        }
        this.all = document.getElementById("was_voted_filter_ALL");
        this.nv = document.getElementById("was_voted_filter_NV");
        this.vo = document.getElementById("was_voted_filter_VO");
        this.all.checked = true;
        this.nv.checked = true;
        this.vo.checked = true;
        this.all.onchange = function(){
          if(this.checked){
            that.nv.checked = true;
            $(that.nv).button("refresh")
            that.vo.checked = true;
            $(that.vo).button("refresh")
          } else {
            that.nv.checked = false;
            $(that.nv).button("refresh")
            that.vo.checked = false;
            $(that.vo).button("refresh")
          }
          that.parent.filteringChanged();
        };
        this.nv.onchange = this.callback;
        this.vo.onchange = this.callback; 
        this.getActiveFilter = function(){
          var filterArray = [];
          if(this.nv.checked){
            filterArray.push("NV")
          }
          if(this.vo.checked){
            filterArray.push("VO")
          }
          return filterArray;
        }
      }
      function executedProjectFilters(parent){
        this.parent = parent;
        var that = this;
        this.callback = function(){
          if(!this.checked){
            that.all.checked = false;
            $(that.all).button("refresh")
          }
          if ((that.no.checked) && (that.yes.checked)){
            that.all.checked = true;
            $(that.all).button("refresh")
          }
          that.parent.filteringChanged();
        }
        this.all = document.getElementById("is_it_executed_filter_ALL");
        this.yes = document.getElementById("is_it_executed_filter_YES");
        this.no = document.getElementById("is_it_executed_filter_NO");
        this.all.checked = true;
        this.yes.checked = true;
        this.no.checked = true;
        this.all.onchange = function(){
          if(this.checked){
            that.no.checked = true;
            $(that.no).button("refresh")
            that.yes.checked = true;
            $(that.yes).button("refresh")
          } else {
            that.no.checked = false;
            $(that.no).button("refresh")
            that.yes.checked = false;
            $(that.yes).button("refresh")
          }
          that.parent.filteringChanged();
        };
        this.no.onchange = this.callback;
        this.yes.onchange = this.callback; 
        this.getActiveFilter = function(){
          var filterArray = [];
          if(this.no.checked){
            filterArray.push("NO")
          }
          if(this.yes.checked){
            filterArray.push("YES")
          }
          return filterArray;
        }
      }      
      function subcategoryFilters(parent) {
        this.parent = parent;
        this.scFilters = document.getElementById("subcategory_filter");
        this.scFilters.multiple = true;
        this.scOptions =[];
        this.isActive = false;
        for (var key in subcategories){
          var option = document.createElement("option");
          option.selected = "selected";
          option.innerHTML = subcategories[key].name;
          option.id = "filter_" + key;
          this.scFilters.appendChild(option);
          this.scOptions.push(option);
        }
        var that = this;
        this.scFilters.onchange = function(){
          that.parent.filteringChanged();
        }
        this.show = function(){
          if(this.isActive == false){
            this.scFilters.style.display = "inherit";
            $(this.scFilters).attr('data-placeholder', "Select Subcategories...").chosen();
            this.isActive = true;
          }
        }
        this.getSelected = function(){
          var selectedSubcategories = [];
          for (var i = 0; i < this.scOptions.length; i++){
            if (this.scOptions[i].selected){
              selectedSubcategories.push(this.scOptions[i].id.slice(7,this.scOptions[i].id.length));
            }
          }
          return selectedSubcategories;
        }
      }
      function budgetBar(){
        this.budgetView = document.getElementById("total_budget");
        this.budgetBar = document.getElementById("budget_bar");
        this.budgetBars = [];
        this.percentages = [];
        for (var key in subcategories){
          this.budgetBars.push(document.getElementById("bar_element_" + key));
        }
        this.updateBar = function(projects){
          this.projects = projects;
          var totalBudget = projects().sum("PLANNED_BUDGET");
          this.budgetView.innerHTML = totalBudget;
          this.percentages = [];
          this.budgetBar.innerHTML = "";
          var i = 0;
          for (var key in subcategories){
            if(totalBudget == 0){
              this.percentages.push(100*(1/Object.keys(subcategories).length));
            } else {
              this.percentages.push(100*((this.projects({SUBCATEGORY : key}).sum("PLANNED_BUDGET"))/totalBudget));
            }
            this.budgetBars[i].style.width = this.percentages[i] + "%";
            this.budgetBars[i].percentage = this.percentages[i];
            i++;
          }
          this.percentages.sort(sortNumber);    
          for (var i = this.percentages.length - 1; i >= 0; i--) {
            for (var j = 0; j < this.budgetBars.length; j++) {
              if(this.budgetBars[j].percentage == this.percentages[i]){
                this.budgetBar.appendChild(this.budgetBars[j]);
              }
            };
          };
        }
      }
      function parseKelurahans(data){
        var rows = data['rows'];
        for (var i in rows) {
          var newCoordinates = [];
          var kelurahan_name = rows[i][0];
          var center = constructNewPointCoordinates(rows[i][2]['geometry']);
          var geometries = rows[i][1]['geometries'];
          if (geometries) {
            for (var j in geometries) {
              newCoordinates.push(constructNewCoordinates(geometries[j]));
            }
          } else {
            newCoordinates = constructNewCoordinates(rows[i][1]['geometry']);
          }
          kelurahans[i] = new kelurahan(kelurahan_name, newCoordinates, center, i);
        }
        drawKelurahans(kelurahans);
        mapSC.addKelurahanSelector();
      }
      function parseSubdivisions(data){
        var rows = data['rows'];
        subdivisions = {};
        for (var i in rows) {
          var newCoordinates = [];
          var kelurahan_name = rows[i][0];
          var center = constructNewPointCoordinates(rows[i][2]['geometry']);
          var geometries = rows[i][1]['geometries'];
          var rw_name = rows[i][3];
          var rt_name = rows[i][4];
          if (geometries) {
            for (var j in geometries) {
              newCoordinates.push(constructNewCoordinates(geometries[j]));
            }
          } else {
            newCoordinates = constructNewCoordinates(rows[i][1]['geometry']);
          }
          if(!subdivisions.hasOwnProperty(kelurahan_name)){
            subdivisions[kelurahan_name] = {};
          }
          if(!subdivisions[kelurahan_name].hasOwnProperty(rw_name)){
            subdivisions[kelurahan_name][rw_name] = {};
          }
          if(!subdivisions[kelurahan_name][rw_name].hasOwnProperty(rt_name)){
            subdivisions[kelurahan_name][rw_name][rt_name] = {};
          }          
          subdivisions[kelurahan_name][rw_name][rt_name] = {
            CENTER : center,
            GEOMETRIES : newCoordinates
          }
        }
      }
      function kelurahan(name, geometry, center, index) {
        this.name = name;
        this.selected = false;
        this.geometry = geometry;
        this.index = index;
        this.center = center;
        this.onMouseOverStyle = null;
        this.normalStyle = null;
        this.selectedStyle = null;
        var projects = null;
        var randomnumber = Math.floor(Math.random() * colors.length);
        this.kelurahanShape = new L.polygon(this.geometry, this.shapeOptions);
        this.getName = function(){
          return this.name;
        }
        this.drawKelurahan = function() {
          this.kelurahanShape.setStyle(this.normalStyle);
          this.kelurahanShape.addTo(kelurahanLayer);
        }
        this.initializeShape = function(){
          this.drawKelurahan();
          this.addListeners();
        }
        this.setStyle = function(style) {
          this.kelurahanShape.setStyle(style);
        }
        this.setOnMouseOverStyle = function(style){
          this.onMouseOverStyle = style;
        }
        this.setNormalStyle = function(style){
          this.normalStyle = style;
        }
        this.setSelectedStyle = function(style){
          this.selectedStyle = style;
        }
        this.setStyles = function(ns,ss,mov){
          this.normalStyle = JSON.parse(JSON.stringify(ns));
          this.selectedStyle = JSON.parse(JSON.stringify(ss));
          this.onMouseOverStyle = JSON.parse(JSON.stringify(mov));
          if(this.selected){
            this.setStyle(this.selectedStyle);
          } else{
            this.setStyle(this.normalStyle);
          }
        }
        this.setSelected = function(){
          this.selected = true;
          this.setStyle(this.selectedStyle);
        }
        this.setDeselected = function(){
          this.selected = false;
          this.setStyle(this.normalStyle);
        }
        this.addListeners = function() {
          var that = this;
          this.kelurahanShape.on("click", function(){
              mapSC.onKelurahanClick(that);
          });
          this.kelurahanShape.on('mouseover', function(){
            if(!that.selected){
              that.setStyle(that.onMouseOverStyle);
            }
            mapSC.onKelurahanMouseOver(that);
          });
          this.kelurahanShape.on('mouseout', function(){ 
            if(!that.selected){
              that.setStyle(that.normalStyle);
            } else {
              that.setStyle(that.selectedStyle);
            }
            mapSC.onKelurahanMouseOut(that);
          });          
        }
      }
      function drawKelurahans(kelurahans) {
        this.kelurahans = kelurahans;
        shuffleArray = [];
        for (var i=0; i < kelurahans.length; i++){
          shuffleArray[i] = i;
        }
        shuffleArray = shuffle(shuffleArray);
        i = 0;
        var interval = setInterval(function(){
          if (i < kelurahans.length){
            kelurahans[shuffleArray[i]].setStyles(originalKelurahanShapeOptions, activeKelurahanShapeOptions, onHoverKelurahanShapeOptions);
            kelurahans[shuffleArray[i]].initializeShape();
            i++;
          } else{
            clearInterval(interval);
          }
        }, 50)
      }
      function getSubcategoryIcons(){
        this.icons = {};
        for(var name in subcategories) {
          var tempIcon = new Image();
          tempIcon.className = "icon-block";
          tempIcon.src = "src/img/png/solo_" + name + ".png";
          tempIcon.innerHTML = subcategories[name].name;
          this.icons[name] = tempIcon;
        }
        this.getIcon = function(code){
          return this.icons[code].cloneNode();
        }
      }
      function constructNewCoordinates(polygon) {
        var newCoordinates = [];
        var coordinates = polygon['coordinates'][0];
        for (var i in coordinates) {
          newCoordinates.push(new L.LatLng(coordinates[i][1], coordinates[i][0]));
        }
        return newCoordinates;
      }
      function constructNewPointCoordinates(originalPoint) {
        var pointCoordinates;
        var pointFromSource = originalPoint["coordinates"];
        pointCoordinates = new L.LatLng(pointFromSource[1], pointFromSource[0]);
        return pointCoordinates;
      }
      function sortNumber(a,b) {
        return a > b ? 1 : a < b ? -1 : 0;
      }
      // Fisher–Yates shuffle
      function shuffle(array) {
        var counter = array.length, temp, index;
        // While there are elements in the array
        while (counter > 0) {
          // Pick a random index
          index = Math.floor(Math.random() * counter);
          // Decrease counter by 1
          counter--;
          // And swap the last element with it
          temp = array[counter];
          array[counter] = array[index];
          array[index] = temp;
        }
        return array;
      }
      //***********************************************************************
      //***************Here goes the stuff for the  info***********************
      //***********************************************************************
      function getProjects() {
        columnNames = getWhatToGet(projectFields);
        var query = 'SELECT ' + columnNames + '  FROM ' + musrenbangFusionTableID;
        getFusionTablesData(query, "parseProjects");
      }

      function parseData(data){
        var rows = data['rows'];
        // Filling a TaffyDB with the information of the projects.
        for (var j in rows){
          var tempObj = {};
          tempObj["INDEX"] = j;
          for (var i=0; i < dataFields.length; i++){
            tempObj[dataFields[i].KEY] = rows[j][i];
          }
          aggregateDataDatabase.insert(tempObj);
        }
      }

      function parseProjects(data){
        var rows = data['rows'];
        // Filling a TaffyDB with the information of the projects.
        for (var j in rows){
          var tempObj = {};
          tempObj["INDEX"] = j;
          for (var i=0; i < projectFields.length; i++){
            if((projectFields[i].KEY == "PLANNED_BUDGET") || (projectFields[i].KEY == " EXECUTED_BUDGET")){
              if(rows[j][i] == ""){
                tempObj[projectFields[i].KEY] = 0;
              } else {
                tempObj[projectFields[i].KEY] = parseInt(rows[j][i]);
              }
            } else {
                tempObj[projectFields[i].KEY] = rows[j][i];
            }
          }
          tempObj["ID"] = tempObj.KELURAHAN + "-" + tempObj.YEAR + "-" + tempObj.CATEGORY + "-" + tempObj.SUBCATEGORY + "-" + tempObj.VOTED + "-" + tempObj.UNIQUE_NUMBER;
          tempObj["SUBCATEGORY_TEXT"] = subcategories[tempObj.SUBCATEGORY].name;
          projectDatabase.insert(tempObj);
        }
        mapSC.onProjectsParsed();
      }
      function projectCard(project, parent){
        var li = document.createElement('li');
        var input = document.createElement("input");
        input.id = project.ID;
        input.name = "accordion-1";
        input.type = "radio"
        li.appendChild(input);
        var label = document.createElement("label");
        label.htmlFor = project.ID;
        label.className = "pc-" + project.SUBCATEGORY;
        var icon = subcategoryIcons.getIcon(project.SUBCATEGORY);
        label.appendChild(icon);
        var div = document.createElement("div");
        div.className = "text-block";
        var h6 = document.createElement("h6");
        h6.innerHTML = project.PROJECT_NAME;
        div.appendChild(h6);
        label.appendChild(div);
        li.appendChild(label);
        var article = document.createElement("article");
        article.className = "ac-small";
        var projectID = document.createElement("p");
        projectID.innerHTML = project.ID;
        article.appendChild(projectID);
        var year = document.createElement("p");
        year.innerHTML = "Year: " + project.YEAR;
        article.appendChild(year);
        var plannedBudget = document.createElement("p");
        plannedBudget.innerHTML = "Planned budget: " + project.PLANNED_BUDGET + " IDR";
        article.appendChild(plannedBudget);
        var executedBudget = document.createElement("p");
        executedBudget.innerHTML = "Executed budget: " + project.EXECUTED_BUDGET + " IDR";
        article.appendChild(executedBudget);        
        li.appendChild(article);  
        label.onclick = function(){
          parent.setSelectedProject(project.ID);
        };
        this.getView = function(){
          return li;
        };
      }
      function fillProjectCards(kelurahan, years, subcategories, ghostOrNot, executedOrNot, parent){
        var list = document.getElementById("list");
        var ul = document.createElement("ul");
        var projectTAFFY = TAFFY();
        var projectCardArray = [];
        for (var j=0; j < years.length; j++){
          for (var k=0; k < subcategories.length; k++){
            for (var l = 0; l < ghostOrNot.length; l++) {
              for (var m = 0; m < executedOrNot.length; m++){
                var projectsToShow = projectDatabase({KELURAHAN : kelurahan, YEAR : ("" + years[j]), SUBCATEGORY : subcategories[k], VOTED : ghostOrNot[l], IS_IT_EXECUTED : executedOrNot[m]}).get();
                for (var i=0; i < projectsToShow.length; i++){
                  projectCardArray[i] = new projectCard(projectsToShow[i], parent);
                  ul.appendChild(projectCardArray[i].getView());
                  projectTAFFY.insert(projectsToShow[i]);
                }
                list.appendChild(ul);
              }
            }
          }
        }
        return projectTAFFY;
      }
      function showDataLayer(key){
        this.normalStyle = {};
        this.onHoverStyle = {};
        this.selectedStyle = {};
        this.normalStyle = originalKelurahanShapeOptions;
        this.onHoverStyle = onHoverKelurahanShapeOptions;
        this.selectedStyle = activeKelurahanShapeOptions;
        for (var i = kelurahans.length - 1; i >= 0; i--) {
          var info = aggregateDataDatabase({KELURAHAN: kelurahans[i].getName()}).get()[0];
          this.normalStyle.fillColor = percentageColor;
          this.onHoverStyle.fillColor = percentageColor;
          this.selectedStyle.fillColor = percentageColor;
          this.normalStyle.fillOpacity = info[key]/100;
          this.onHoverStyle.fillOpacity = info[key]/100;
          this.selectedStyle.fillOpacity = info[key]/100;
          kelurahans[i].setStyles(this.normalStyle, this.selectedStyle, this.onHoverStyle);
        };
      }
      function emptyProjectCards(){
        var list = document.getElementById("list");
        list.innerHTML = "";
      }
      //***********************************************************************
      //*************Here goes the stuff related to Fusion Tables**************
      //***********************************************************************
      function getFusionTablesData(query, callback){
        var script = document.createElement('script');
        var url = ['https://www.googleapis.com/fusiontables/v1/query?'];
        url.push('sql=');
        var encodedQuery = encodeURIComponent(query);
        url.push(encodedQuery);
        url.push('&callback=' + callback);
        url.push('&key=AIzaSyAhX7a_0uyiA8DfW-4XJ6ZN_ay8GkAGrz0');
        script.src = url.join('');
        var body = document.getElementsByTagName('body')[0];
        body.appendChild(script);
      }  
      function getWhatToGet(columnNames){
        var whatToGet = "";
        for (var i = 0; i < columnNames.length; i++){
          whatToGet = whatToGet + columnNames[i].KEY + ", ";
        }
        whatToGet = whatToGet.substring(0, whatToGet.length - 2);
        return whatToGet;
      }
    </script>
    <script src="http://yui.yahooapis.com/3.17.2/build/yui/yui-min.js"></script>
    <script>
      YUI().use('node-base', 'node-event-delegate', function (Y) {
        var menuButton = Y.one('.nav-menu-button'),
          nav   = Y.one('#nav');
        // Setting the active class name expands the menu vertically on small screens.
        menuButton.on('click', function (e) {
          nav.toggleClass('active');
        });
        // Your application code goes here...
      });
    </script>
  </body>
</html>